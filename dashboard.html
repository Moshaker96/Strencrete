<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strencrete Dashboard</title>
  <script type="module">
    // ‚úÖ Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-firestore.js";

    // ‚úÖ Fixed Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDMdxriLa_8LDxnEt6o8FhQgzuoFrGCY1M",
      authDomain: "concretelive.firebaseapp.com",
      projectId: "concretelive",
      storageBucket: "concretelive.appspot.com",   // üî• FIXED
      messagingSenderId: "605153900631",
      appId: "1:605153900631:web:68c72f63bdb2929a348b12"
    };

    // ‚úÖ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const projectsRef = collection(db, "strencrete");

    // Check auth
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        console.log("‚ö†Ô∏è Not logged in, redirecting to login.html");
        window.location.href = "login.html";
      } else {
        console.log("‚úÖ Logged in:", user.email);
        loadProjects();
      }
    });

    // Load projects
    async function loadProjects() {
      const container = document.getElementById("projects-container");
      container.innerHTML = "<p>Loading...</p>";

      try {
        const snapshot = await getDocs(projectsRef);
        if (snapshot.empty) {
          container.innerHTML = "<p>No data found</p>";
          return;
        }

        container.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.textContent = `${data.name} - ${data.status} (${data.sensors} sensors)`;
          container.appendChild(div);
        });
      } catch (err) {
        console.error("Error loading projects:", err);
        container.innerHTML = "<p style='color:red'>Error loading data</p>";
      }
    }

    // Save form
    window.saveProject = async function () {
      const name = document.getElementById("name").value;
      const status = document.getElementById("status").value;
      const sensors = parseInt(document.getElementById("sensors").value, 10);

      if (!name || !status || isNaN(sensors)) {
        alert("Please fill all fields correctly.");
        return;
      }

      try {
        console.log("Adding document to Firestore:", { name, status, sensors });
        await addDoc(projectsRef, {
          name,
          status,
          sensors,
          createdAt: serverTimestamp()
        });
        alert("‚úÖ Project saved!");
        loadProjects();
      } catch (err) {
        console.error("Error saving:", err);
        alert("‚ùå Failed to save project");
      }
    };
  </script>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <h1>Strencrete Overview</h1>
  <p>Monitor and manage your Strencrete data in real-time.</p>

  <div id="projects-container" style="margin: 20px 0; padding: 10px; border: 1px solid #ddd;">
    No data found
  </div>

  <h2>Add Strencrete Entry</h2>
  <div style="margin-top: 10px;">
    <label>Name <input id="name" type="text" /></label><br /><br />
    <label>Status 
      <select id="status">
        <option value="">Select...</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
      </select>
    </label><br /><br />
    <label>Number of Sensors <input id="sensors" type="number" /></label><br /><br />
    <button onclick="saveProject()">Save</button>
  </div>
</body>
</html>
