<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js';
  import { getFirestore, collection, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.8.1/firebase-firestore.js';

  // Your Firebase project configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAaGp3HXLD5QQnkHSODAmyTOvqbPlF4sCo",
    authDomain: "concretelive.firebaseapp.com",
    projectId: "concretelive",
    storageBucket: "concretelive.appspot.com",
    messagingSenderId: "605153900631",
    appId: "1:605153900631:web:68c72f63bdb2929a348b12"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app); // Initialize Firestore

  // Get DOM elements
  const userNameElement = document.getElementById('userName');
  const userEmailElement = document.getElementById('userEmail');
  const signOutBtn = document.getElementById('signOutBtn');
  const createProjectBtn = document.getElementById('createProjectBtn');
  const projectsContent = document.getElementById('projectsContent');

  // This is a crucial function that listens for changes in the user's sign-in state.
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User is signed in.
      userNameElement.textContent = user.displayName || 'User';
      userEmailElement.textContent = user.email;
      console.log("User is logged in:", user.uid);

      // This is necessary to render the icons inside the sidebar and button
      lucide.createIcons();

      // ** NEW: Start listening for projects data from Firestore **
      // Use a simple, top-level collection name.
      // Make sure this matches the collection name you created in the console.
      const projectsCollectionRef = collection(db, 'projects');

      onSnapshot(projectsCollectionRef, (snapshot) => {
        const projectCardsHTML = [];
        snapshot.forEach(doc => {
          const project = doc.data();
          const statusColor = project.status === 'Active' ? 'bg-green-100 text-green-800' :
                              project.status === 'On Hold' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-gray-100 text-gray-800';

          // Create the HTML for each project card
          projectCardsHTML.push(`
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300">
              <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-semibold text-gray-900">${project.name}</h3>
                <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                  ${project.status}
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-2">Sensors: ${project.sensors}</p>
              <p class="text-sm text-gray-500">Last updated: ${project.lastUpdated || 'N/A'}</p>
            </div>
          `);
        });

        // If there are projects, display them; otherwise, show the "No projects" message.
        if (projectCardsHTML.length > 0) {
          projectsContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${projectCardsHTML.join('')}</div>`;
        } else {
          projectsContent.innerHTML = `
            <div class="text-center p-8 bg-white rounded-2xl shadow-lg border border-gray-100">
              <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-gray-400 mb-4"></i>
              <h3 class="mt-2 text-lg font-medium text-gray-900">No projects found</h3>
              <p class="mt-1 text-sm text-gray-500">
                Get started by creating a new project.
              </p>
            </div>
          `;
          lucide.createIcons(); // Re-render icons after changing innerHTML
        }
      });

    } else {
      // User is signed out.
      console.log("User is not logged in. Redirecting to login page.");
      window.location.href = 'login.html';
    }
  });

  // Add an event listener to the Sign Out button
  signOutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
      console.log("User signed out successfully.");
    }).catch((error) => {
      console.error("Error signing out:", error);
    });
  });

  // Add event listener to the "Create Project" button
  createProjectBtn.addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center';
      modal.innerHTML = `
        <div class="p-8 border w-96 shadow-lg rounded-md bg-white">
          <h3 class="text-lg font-bold">Create Project</h3>
          <p class="text-sm text-gray-500 mt-2">
            Create Project button clicked! You can add a form or a modal here.
          </p>
          <div class="mt-4 flex justify-end">
            <button id="closeModal" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
              Close
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('closeModal').addEventListener('click', () => {
          document.body.removeChild(modal);
      });
  });
</script>
