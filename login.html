<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    fetchSignInMethodsForEmail,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAaGp3HXLD5QQnkHSODAmyTOvqbPlF4sCo",
    authDomain: "concretelive.firebaseapp.com",
    projectId: "concretelive",
    storageBucket: "concretelive.appspot.com",
    messagingSenderId: "605153900631",
    appId: "1:605153900631:web:68c72f63bdb2929a348b12"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // DOM elements
  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordContainer = document.getElementById('passwordContainer');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const messageBox = document.getElementById('messageBox');
  const userStatusDisplay = document.getElementById('userStatus');
  const logoutContainer = document.getElementById('logoutContainer');
  const logoutBtn = document.getElementById('logoutBtn');

  // Show password from start
  passwordContainer.classList.remove('hidden');
  passwordInput.setAttribute('required', 'required');

  function showMessage(text, isError = false) {
    messageBox.textContent = text;
    messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700');
    messageBox.classList.add(isError ? 'bg-red-100' : 'bg-blue-100');
    messageBox.classList.add(isError ? 'text-red-700' : 'text-blue-700');
  }

  function hideMessage() {
    messageBox.classList.add('hidden');
  }

  // Auth state change
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userStatusDisplay.textContent = `Currently logged in as: ${user.email}`;
      userStatusDisplay.classList.remove('hidden', 'bg-red-100', 'text-red-700');
      userStatusDisplay.classList.add('bg-green-100', 'text-green-700');
      loginForm.classList.add('hidden');
      logoutContainer.classList.remove('hidden');
    } else {
      userStatusDisplay.textContent = "No user signed in.";
      userStatusDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-700');
      userStatusDisplay.classList.add('bg-red-100', 'text-red-700');
      loginForm.classList.remove('hidden');
      logoutContainer.classList.add('hidden');
    }
  });

  // Single-step login/create
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage();
    submitBtn.disabled = true;

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      showMessage('Please enter both email and password.', true);
      submitBtn.disabled = false;
      return;
    }

    try {
      const methods = await fetchSignInMethodsForEmail(auth, email);
      if (methods.includes('password')) {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('Sign in successful!');
      } else if (methods.length === 0) {
        await createUserWithEmailAndPassword(auth, email, password);
        showMessage('Account created successfully!');
      } else {
        showMessage('This email is not associated with an email/password login.', true);
      }
    } catch (error) {
      showMessage(`Error: ${error.message}`, true);
    }
    submitBtn.disabled = false;
  });

  // Logout
  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      showMessage('You have been signed out.', false);
      emailInput.value = '';
      passwordInput.value = '';
    } catch (error) {
      showMessage(`Sign-out failed: ${error.message}`, true);
    }
  });

  console.log("Strencrete login script loaded with single-click login.");
</script>
