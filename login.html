import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  fetchSignInMethodsForEmail,
  GoogleAuthProvider,
  signInWithPopup
} from 'firebase/auth';

// Main App component
export default function App() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [message, setMessage] = useState('');
  const [isError, setIsError] = useState(false);
  const [buttonText, setButtonText] = useState('Continue');
  
  // Firebase initialization and auth instance
  const [auth, setAuth] = useState(null);
  
  // Initialize Firebase on component mount
  useEffect(() => {
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyAcr5TenAk29l84SAOf0DfUDufw76H8F9A",
        authDomain: "concretelive.firebaseapp.com",
        projectId: "concretelive",
        storageBucket: "concretelive.firebasestorage.app",
        messagingSenderId: "605153900631",
        appId: "1:605153900631:web:68c72f63bdb2929a348b12"
      };
      
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      setAuth(authInstance);
      console.log("Firebase initialized successfully.");
    } catch (error) {
      console.error("Firebase initialization failed:", error);
      setMessage(`Initialization failed: ${error.message}`);
      setIsError(true);
    }
  }, []);

  // Handler for displaying messages
  const showMessage = (text, error = false) => {
    setMessage(text);
    setIsError(error);
  };

  // Main form submission logic
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!auth) {
      showMessage("Firebase is not initialized.", true);
      return;
    }

    showMessage(''); // Clear previous messages
    
    // First step: Check email and determine next action
    if (buttonText === 'Continue') {
      try {
        const methods = await fetchSignInMethodsForEmail(auth, email);
        
        if (methods.length === 0) {
          // Email not found, prompt for a new account
          showMessage('Email not found. Please create a new account by entering a password.');
          setShowPassword(true);
          setButtonText('Create Account');
        } else {
          // Email exists, prompt for a password
          showMessage('Please enter your password to sign in.');
          setShowPassword(true);
          setButtonText('Sign In');
        }
      } catch (error) {
        showMessage(`An error occurred: ${error.message}`, true);
      }
    } 
    // Second step: Sign In or Create Account
    else if (buttonText === 'Sign In') {
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('Sign in successful! Redirecting...', false);
        // In a real app, you'd redirect here.
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          showMessage('Incorrect password. Please try again.', true);
        } else {
          showMessage(`Sign-in failed: ${error.message}`, true);
        }
      }
    } else if (buttonText === 'Create Account') {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showMessage('Account created successfully! Redirecting...', false);
        // In a real app, you'd redirect here.
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          // This is the key fix: if the email is already in use, switch to the sign-in flow.
          showMessage('This email is already in use. Please sign in instead.');
          setButtonText('Sign In');
        } else {
          showMessage(`Account creation failed: ${error.message}`, true);
        }
      }
    }
  };

  // Google sign-in logic
  const handleGoogleSignIn = async () => {
    if (!auth) {
      showMessage("Firebase is not initialized.", true);
      return;
    }
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
      showMessage('Google sign in successful! Redirecting...', false);
    } catch (error) {
      showMessage(`Google sign-in failed: ${error.message}`, true);
    }
  };

  return (
    <div className="login-bg flex items-center justify-center min-h-screen">
      <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-md mx-4 sm:mx-auto z-10 relative">
        <div className="text-center">
          <img src="strencrete-logo.jpg" onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/128x128/e5e7eb/6b7280?text=LOGO'; }} alt="Strencrete Logo" className="w-32 h-auto mx-auto mb-4 rounded-lg shadow" />
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Dashboard Login</h1>
          <p className="text-gray-500 mb-8">Sign in to monitor your projects.</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email address</label>
            <div className="mt-1">
              <input 
                id="email" 
                name="email" 
                type="email" 
                autoComplete="email" 
                required 
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="input-field appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>
          </div>

          {showPassword && (
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700">Password</label>
              <div className="mt-1">
                <input 
                  id="password" 
                  name="password" 
                  type="password" 
                  autoComplete="current-password" 
                  required 
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="input-field appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
              </div>
            </div>
          )}

          {message && (
            <div className={`message-box p-3 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`} role="alert">
              {message}
            </div>
          )}

          <div>
            <button type="submit" className="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
              {buttonText}
            </button>
          </div>
          
          <div className="relative mt-6">
            <div className="absolute inset-0 flex items-center" aria-hidden="true">
              <div className="w-full border-t border-gray-300"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-white text-gray-500">
                Or continue with
              </span>
            </div>
          </div>
          
          <div className="mt-6">
            <button type="button" onClick={handleGoogleSignIn} className="w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
              <svg className="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M19.7 9.5h-1.3v1.3h-1.3v-1.3h-1.3v-1.3h1.3v-1.3h1.3v1.3h1.3v1.3zm-10.7-3.7c1.8 0 3.3 1.5 3.3 3.3s-1.5 3.3-3.3 3.3-3.3-1.5-3.3-3.3 1.5-3.3 3.3-3.3zm0-1c-2.4 0-4.3 1.9-4.3 4.3s1.9 4.3 4.3 4.3 4.3-1.9 4.3-4.3-1.9-4.3-4.3-4.3zm-1 8.3c-.6 0-1.1-.5-1.1-1.1s.5-1.1 1.1-1.1 1.1.5 1.1 1.1-.5 1.1-1.1 1.1zm-3.3-5.3c-.6 0-1.1-.5-1.1-1.1s.5-1.1 1.1-1.1 1.1.5 1.1 1.1-.5 1.1-1.1 1.1z"/>
                <path d="M18.8 8h-1.6v2.2h1.6z"/>
                <path d="M12.9 6c-2.4 0-4.3 1.9-4.3 4.3s1.9 4.3 4.3 4.3 4.3-1.9 4.3-4.3-1.9-4.3-4.3-4.3zm0 7.3c-1.7 0-3-1.4-3-3s1.3-3 3-3 3 1.4 3 3-1.3 3-3 3zm-2.8-5.3c-.6 0-1.1-.5-1.1-1.1s.5-1.1 1.1-1.1 1.1.5 1.1 1.1-.5 1.1-1.1 1.1z"/>
                <path d="M19.7 9.5h-1.3v1.3h-1.3v-1.3h-1.3v-1.3h1.3v-1.3h1.3v1.3h1.3v1.3zM10.8 14.2c-1.8 0-3.3-1.5-3.3-3.3s1.5-3.3 3.3-3.3 3.3 1.5 3.3 3.3-1.5 3.3-3.3 3.3zM10.8 6.9c-2.4 0-4.3 1.9-4.3 4.3s1.9 4.3 4.3 4.3 4.3-1.9 4.3-4.3-1.9-4.3-4.3-4.3z"/>
                <path fill="currentColor" d="M10.8 14.2c-1.8 0-3.3-1.5-3.3-3.3s1.5-3.3 3.3-3.3 3.3 1.5 3.3 3.3-1.5 3.3-3.3 3.3zM10.8 6.9c-2.4 0-4.3 1.9-4.3 4.3s1.9 4.3 4.3 4.3 4.3-1.9 4.3-4.3-1.9-4.3-4.3-4.3zM20 9.5h-1.6v2.2h1.6V9.5zM12.9 6c-2.4 0-4.3 1.9-4.3 4.3s1.9 4.3 4.3 4.3 4.3-1.9 4.3-4.3-1.9-4.3-4.3-4.3zM10.8 14.2c-1.8 0-3.3-1.5-3.3-3.3s1.5-3.3 3.3-3.3 3.3 1.5 3.3 3.3-1.5 3.3-3.3 3.3z"/>
              </svg>
              Sign in with Google
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
